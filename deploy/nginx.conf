# Nginx configuration for fin.omisli.si static dashboard

{% if secure %}
# HTTP to HTTPS redirect
server {
    listen       80;
    server_name  {{ domain_name }};
    return       301 https://{{ domain_name }}$request_uri;
}

# HTTPS server
server {
    listen      443 ssl http2;
    server_name {{ domain_name }};
    charset     utf-8;
    server_tokens off;
    keepalive_timeout 20s;
    tcp_nopush      on;

    # SSL configuration
    ssl_certificate /etc/letsencrypt/live/{{ domain_name }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{{ domain_name }}/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/ssl/certs/dhparam.pem;

    ssl_session_cache shared:SSL:50m;
    ssl_buffer_size 4k;
    ssl_stapling on;
    ssl_stapling_verify on;

    # Force HTTPS
    if ($scheme != "https") {
        return 301 https://$host$request_uri;
    }
{% else %}
# HTTP server (before SSL certificate is set up)
server {
    listen      80;
    server_name {{ domain_name }};
    charset     utf-8;
    server_tokens off;
    keepalive_timeout 20s;
    tcp_nopush      on;
{% endif %}

    # Gzip compression
    gzip on;
    gzip_comp_level    5;
    gzip_min_length    256;
    gzip_proxied any;
    gzip_vary          on;
    gzip_types
        application/javascript
        application/json
        application/xhtml+xml
        application/xml
        image/svg+xml
        text/css
        text/plain
        text/xml;

    # Let's Encrypt ACME challenge (must be accessible without auth)
    location /.well-known/acme-challenge/ {
        root {{ web_directory }};
        allow all;
        auth_basic off;  # Disable auth for ACME challenge
    }

    # HTTP Basic Authentication
    auth_basic            "Restricted Access";
    auth_basic_user_file  /etc/nginx/htpasswd-fin;

    # Serve static files
    root {{ web_directory }};
    index index.html;

    # Cache static assets
    location /static/ {
        alias {{ web_directory }}/static/;
        access_log off;
        add_header Cache-Control "max-age=2592000";
        expires 30d;
    }

    # Main location - serve dashboard
    location / {
        try_files $uri $uri/ /index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:;" always;
}

